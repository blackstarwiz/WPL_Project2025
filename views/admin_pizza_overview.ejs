<%- include('partials/header') %>
<main>
  <h1>PIZZA BEHEER</h1>


  <!-- ADD FORM -->
  <section>
    <h2>Toevoegen</h2>
    <form action="/admin/pizza-overview/add" method="POST">

      <label>Naam</label>
      <input type="text" name="name" required>

      <label>Prijs</label>
      <input type="text" name="price" required>

      <label>Ingrediënten (komma gescheiden)</label>
      <input type="text" name="ingredients">

      <label>Afbeelding upload (ImgBB)</label>
      <input type="file" id="addImage" accept="image/*">
      <button type="button" onclick="uploadAddImage()">Upload</button>

      <div id="addImagePreview"></div>
      <input type="hidden" name="imageUrl" id="addImageUrl">

      <button type="submit">Toevoegen</button>
    </form>
  </section>

  <hr>

  <!-- EDIT FORM-->
  <section>
    <h2>Bewerken</h2>

    <!-- Dropdown: pizza selecteren -->
    <form action="/admin/pizza-overview/edit" method="POST">
      <label>Selecteer pizza</label>
      <select name="pizzaName">
        <option disabled selected>Kies een pizza...</option>
        <% pizzas.forEach(name => { %>
          <option value="<%= name %>" <%= pizza && pizza.name === name ? "selected" : "" %>><%= name %></option>
        <% }) %>
      </select>
      <button type="submit">Laad pizza</button>
    </form>

<% if (pizza) { %>
  <hr>
  <h3>Bewerken: <%= pizza.name %></h3>

  <form action="/admin/pizza-overview/save" method="POST">
    <input type="hidden" name="oldName" value="<%= pizza.name %>">

    <label>Nieuwe naam</label>
    <input type="text" name="newName" value="<%= pizza.name %>" required>

    <label>Prijs</label>
    <input type="text" name="price" value="<%= pizza.price %>" required>

    <label>Ingrediënten (komma gescheiden)</label>
    <input type="text" name="ingredients" value="<%= pizza.ingredients.join(', ') %>">

    <label>Afbeelding upload (ImgBB)</label>
    <input type="file" id="editImage" accept="image/*">
    <button type="button" onclick="uploadEditImage()">Upload</button>

    <div id="editImagePreview">
      <% if (pizza.image) { %>
        <img src="<%= pizza.image %>" width="150">
      <% } %>
    </div>

    <input type="hidden" name="imageUrl" id="editImageUrl" value="<%= pizza.image %>">

    <button type="submit">Opslaan</button>
  </form>

  <!--DELETE FORM (KNOP)-->
  <form 
    action="/admin/pizza-overview/delete" 
    method="POST" 
    onsubmit="return confirm('Weet je zeker dat je deze pizza wilt verwijderen?');"
    style="margin-top:10px;"
  >
    <input type="hidden" name="pizzaName" value="<%= pizza.name %>">
    <button type="submit">Verwijderen</button>
  </form>
<% } %>

  </section>

  <script>
    // Upload helper functie
    async function uploadToImgBB(file, previewId, inputId) {
      const form = new FormData();
      form.append("key", "0100d0335817b15fe19145925a6d39ce");
      form.append("image", file);

      const response = await fetch("https://api.imgbb.com/1/upload", {
        method: "POST",
        body: form
      });

      const data = await response.json();
      if (!data.success) {
        alert("Upload mislukt");
        return;
      }

      const url = data.data.url;
      document.getElementById(previewId).innerHTML = `<img src="${url}" width="150">`;
      document.getElementById(inputId).value = url;
    }

    async function uploadAddImage() {
      const file = document.getElementById("addImage").files[0];
      if (!file) return;
      await uploadToImgBB(file, "addImagePreview", "addImageUrl");
    }

    async function uploadEditImage() {
      const file = document.getElementById("editImage").files[0];
      if (!file) return;
      await uploadToImgBB(file, "editImagePreview", "editImageUrl");
    }
  </script>
</main>
<%- include('partials/footer') %>
